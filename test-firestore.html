<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Firestore</title>
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDVyqJFUICzq3o7dltH6mp5hX8XyqjReVM",
            authDomain: "klientti-640d4.firebaseapp.com",
            projectId: "klientti-640d4",
            storageBucket: "klientti-640d4.firebasestorage.app",
            messagingSenderId: "312229310073",
            appId: "1:312229310073:web:853fd246d899fd73002ea8",
            measurementId: "G-426PNT15KF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // DOM elements
        const loginBtn = document.getElementById('loginBtn');
        const dataDiv = document.getElementById('dataDiv');
        const userInfo = document.getElementById('userInfo');
        const areasDiv = document.getElementById('areasDiv');
        const feedbacksDiv = document.getElementById('feedbacksDiv');
        const usersDiv = document.getElementById('usersDiv');

        // Login function
        loginBtn.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                console.log('Usu치rio logado:', result.user);
                loadData();
            } catch (error) {
                console.error('Erro no login:', error);
            }
        });

        // Load all data
        async function loadData() {
            try {
                // Load areas
                const areasQuery = query(collection(db, 'areas'));
                const areasSnapshot = await getDocs(areasQuery);
                const areas = areasSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                areasDiv.innerHTML = `
                    <h3>츼reas (${areas.length})</h3>
                    <pre>${JSON.stringify(areas, null, 2)}</pre>
                `;

                // Load feedbacks
                const feedbacksQuery = query(collection(db, 'feedbacks'));
                const feedbacksSnapshot = await getDocs(feedbacksQuery);
                const feedbacks = feedbacksSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                feedbacksDiv.innerHTML = `
                    <h3>Feedbacks (${feedbacks.length})</h3>
                    <pre>${JSON.stringify(feedbacks, null, 2)}</pre>
                `;

                // Load users
                const usersQuery = query(collection(db, 'users'));
                const usersSnapshot = await getDocs(usersQuery);
                const users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                usersDiv.innerHTML = `
                    <h3>Usu치rios (${users.length})</h3>
                    <pre>${JSON.stringify(users, null, 2)}</pre>
                `;

                // Show user info
                const user = auth.currentUser;
                if (user) {
                    userInfo.innerHTML = `
                        <h3>Usu치rio Logado</h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>UID:</strong> ${user.uid}</p>
                        
                        <h4>츼reas do Usu치rio</h4>
                        <ul>
                            ${areas.filter(area => area.userId === user.uid).map(area => 
                                `<li>${area.name} (ID: ${area.id})</li>`
                            ).join('')}
                        </ul>
                        
                        <h4>Feedbacks Relacionados</h4>
                        <ul>
                            ${feedbacks.filter(feedback => {
                                const area = areas.find(a => a.id === feedback.areaId);
                                return area && area.userId === user.uid;
                            }).map(feedback => 
                                `<li>Rating: ${feedback.rating}/5 - ${feedback.comment?.substring(0, 50)}...</li>`
                            ).join('')}
                        </ul>
                    `;
                }

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                loginBtn.style.display = 'none';
                dataDiv.style.display = 'block';
                loadData();
            } else {
                loginBtn.style.display = 'block';
                dataDiv.style.display = 'none';
            }
        });
    </script>
</head>
<body>
    <h1>游빍 Teste do Firestore</h1>
    
    <button id="loginBtn">游댏 Login com Google</button>
    
    <div id="dataDiv" style="display: none;">
        <div id="userInfo"></div>
        
        <div id="areasDiv"></div>
        <div id="feedbacksDiv"></div>
        <div id="usersDiv"></div>
    </div>
</body>
</html> 